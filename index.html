<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>看護ステーション安全点検アプリ (データ永続化版)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // ★★★ パスワード設定（ここを変更してください） ★★★
        const CORRECT_PASSWORD = 'nurse2025';

        // --- データ永続化の設定 ---
        const STORAGE_KEY = 'safetyInspectionData';

        // 点検項目リスト（データ永続化のために、コンポーネント外に定義）
        const checkItems = [
            { id: 1, item: '作業机の照明は十分に確保されているか' },
            { id: 2, item: 'タコ足配線がないか' },
            { id: 3, item: '期限切れの掲示物が貼られていないか' },
            { id: 4, item: '通路に障害物がないか' },
            { id: 5, item: '消火器の位置が明確で使用可能か' },
            { id: 6, item: '医療機器の配置は適切か' },
            { id: 7, item: '床に水濡れや滑りやすい箇所はないか' },
            { id: 8, item: '救急カートの配置と中身は適切か' },
            { id: 9, item: 'ゴミ箱は適切に分別・配置されているか' },
            { id: 10, item: '薬品や医療材料の保管は適切か' }
        ];

        // 新しい点検箇所の選択肢
        const inspectionLocations = [
            '外来',
            'スタッフルーム',
            '1階ナースステーション',
            '2階ナースステーション'
        ];

        const getInitialData = () => {
            const initialCheckResults = checkItems.reduce((acc, item) => {
                acc[item.id] = { status: null, photo: null, comment: '' };
                return acc;
            }, {});
            
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // 互換性を担保しつつ、新しい inspectionLocation を追加
                    return {
                        ...parsedData,
                        inspectionLocation: parsedData.inspectionLocation || '' // 新しい項目を追加
                    };
                }
            } catch (e) {
                console.error("LocalStorageの読み込みエラー:", e);
            }
            
            // 初期値
            return {
                checkResults: initialCheckResults,
                inspector: '',
                inspectionDate: new Date().toISOString().split('T')[0],
                inspectionLocation: '' // 初期値
            };
        };

        // --- アイコンコンポーネント (省略なし) ---
        const Camera = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </svg>
        );
        
        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );
        
        const Check = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );
        
        const AlertTriangle = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );
        
        const X = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );
        
        const Lock = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        );
        
        // --- ログイン画面コンポーネント (変更なし) ---
        const LoginScreen = ({ onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === CORRECT_PASSWORD) {
                    onLogin();
                } else {
                    setError('パスワードが違います');
                    setPassword('');
                }
            };
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center justify-center w-16 h-16 bg-indigo-100 rounded-full mb-4">
                                <Lock size={32} className="text-indigo-600" />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800 mb-2">
                                看護ステーション安全点検
                            </h1>
                            <p className="text-gray-600">パスワードを入力してください</p>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    パスワード
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => {
                                        setPassword(e.target.value);
                                        setError('');
                                    }}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="パスワードを入力"
                                    autoFocus
                                />
                                {error && (
                                    <p className="text-red-500 text-sm mt-2">{error}</p>
                                )}
                            </div>
                            
                            <button
                                type="submit"
                                className="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors"
                            >
                                ログイン
                            </button>
                        </form>
                        
                        <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                            <p className="text-xs text-gray-500 text-center">
                                ※初期パスワード: nurse2025<br/>
                                （コード内で変更可能）
                            </p>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- メインアプリコンポーネント (LocalStorage対応) ---
        const SafetyInspectionApp = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            
            const inspectors = [
                '山田 太郎',
                '佐藤 花子',
                '鈴木 一郎',
                '田中 美咲',
                '伊藤 健太'
            ];
            
            // LocalStorageから初期データをロード
            const initialData = getInitialData();
            const [inspector, setInspector] = useState(initialData.inspector);
            const [inspectionDate, setInspectionDate] = useState(initialData.inspectionDate);
            const [inspectionLocation, setInspectionLocation] = useState(initialData.inspectionLocation); // ★追加
            const [checkResults, setCheckResults] = useState(initialData.checkResults);
            
            // ★★★ データの変更時にLocalStorageに保存する処理 ★★★
            useEffect(() => {
                const dataToSave = JSON.stringify({
                    inspector,
                    inspectionDate,
                    inspectionLocation, // ★追加
                    checkResults
                });
                localStorage.setItem(STORAGE_KEY, dataToSave);
            }, [inspector, inspectionDate, inspectionLocation, checkResults]); // ★依存リストに追加

            // ログインしていない場合はログイン画面を表示
            if (!isAuthenticated) {
                // ログイン成功時にLocalStorageのデータでStateを更新し直す
                const handleLogin = () => {
                    setIsAuthenticated(true);
                    const reloadedData = getInitialData();
                    setInspector(reloadedData.inspector);
                    setInspectionDate(reloadedData.inspectionDate);
                    setInspectionLocation(reloadedData.inspectionLocation); // ★追加
                    setCheckResults(reloadedData.checkResults);
                };
                return <LoginScreen onLogin={handleLogin} />;
            }
            
            // 各種ハンドラー関数
            const handleStatusChange = (id, status) => {
                setCheckResults(prev => ({
                    ...prev,
                    [id]: { ...prev[id], status }
                }));
            };
            
            const handlePhotoUpload = (id, e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setCheckResults(prev => ({
                            ...prev,
                            [id]: { ...prev[id], photo: reader.result }
                        }));
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const handleCommentChange = (id, comment) => {
                setCheckResults(prev => ({
                    ...prev,
                    [id]: { ...prev[id], comment }
                }));
            };
            
            const getStatusText = (status) => {
                switch(status) {
                    case 'good': return '良好';
                    case 'warning': return '要改善';
                    case 'danger': return '危険';
                    default: return '未評価';
                }
            };
            
            const getStatusScore = (status) => {
                switch(status) {
                    case 'good': return 3;
                    case 'warning': return 2;
                    case 'danger': return 1;
                    default: return 0;
                }
            };
            
            const calculateTotalScore = () => {
                let totalScore = 0;
                let evaluatedCount = 0;
                
                checkItems.forEach((item) => {
                    const result = checkResults[item.id];
                    const score = getStatusScore(result.status);
                    if (result.status !== null) { // nullでないものだけカウント
                        evaluatedCount++;
                        totalScore += score;
                    }
                });
                
                const maxScore = checkItems.length * 3;
                const scorePercentage = checkItems.length > 0 ? Math.round((totalScore / maxScore) * 100) : 0;

                return { totalScore, maxScore, scorePercentage, evaluatedCount };
            };
            
            const generatePDF = () => {
                if (!inspector || !inspectionLocation) { // ★点検箇所も必須に
                    alert('点検者と点検箇所を選択してください');
                    return;
                }
                
                try {
                    const { totalScore, maxScore, scorePercentage, evaluatedCount } = calculateTotalScore();
                    
                    let htmlContent = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安全点検報告書_${inspectionDate}</title>
    <style>
        /* PDF出力用のCSSスタイルは変更なし */
        body { font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: white; }
        h1 { text-align: center; color: #333; border-bottom: 3px solid #4F46E5; padding-bottom: 10px; }
        .info-section { background: #F3F4F6; padding: 15px; margin: 20px 0; border-radius: 8px; }
        .score-section { background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); color: white; padding: 20px; margin: 20px 0; border-radius: 12px; text-align: center; }
        .score-big { font-size: 48px; font-weight: bold; margin: 10px 0; }
        .score-detail { font-size: 18px; margin: 5px 0; }
        .check-item { border: 1px solid #E5E7EB; margin: 20px 0; padding: 15px; border-radius: 8px; page-break-inside: avoid; }
        .item-title { font-weight: bold; color: #1F2937; margin-bottom: 10px; font-size: 16px; }
        .status { display: inline-block; padding: 5px 15px; border-radius: 5px; font-weight: bold; margin: 10px 0; }
        .status-good { background: #10B981; color: white; }
        .status-warning { background: #F59E0B; color: white; }
        .status-danger { background: #EF4444; color: white; }
        .status-none { background: #9CA3AF; color: white; }
        .photo { max-width: 100%; height: auto; margin: 10px 0; border: 1px solid #D1D5DB; border-radius: 5px; }
        .comment { background: #FEF3C7; padding: 10px; margin: 10px 0; border-left: 4px solid #F59E0B; border-radius: 4px; }
        .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #E5E7EB; color: #6B7280; }
        .score-badge { display: inline-block; background: white; color: #667EEA; padding: 3px 10px; border-radius: 5px; font-weight: bold; margin-left: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>看護ステーション安全点検報告書</h1>
    
    <div class="info-section">
        <p><strong>点検箇所:</strong> ${inspectionLocation}</p> <p><strong>点検日:</strong> ${inspectionDate}</p>
        <p><strong>点検者:</strong> ${inspector}</p>
        <p><strong>作成日時:</strong> ${new Date().toLocaleString('ja-JP')}</p>
    </div>
    
    <div class="score-section">
        <div style="font-size: 24px; margin-bottom: 10px;">総合評価</div>
        <div class="score-big">${totalScore} / ${maxScore}点</div>
        <div class="score-detail">達成率: ${scorePercentage}%</div>
        <div class="score-detail" style="margin-top: 15px; font-size: 14px; opacity: 0.9;">
            評価済み項目: ${evaluatedCount} / ${checkItems.length}
        </div>
    </div>
`;
                    
                    checkItems.forEach((item, index) => {
                        const result = checkResults[item.id];
                        const statusText = getStatusText(result.status);
                        const scorePoints = getStatusScore(result.status);
                        let statusClass = 'status-none';
                        
                        if (result.status === 'good') {
                            statusClass = 'status-good';
                        } else if (result.status === 'warning') {
                            statusClass = 'status-warning';
                        } else if (result.status === 'danger') {
                            statusClass = 'status-danger';
                        }
                        
                        htmlContent += `
    <div class="check-item">
        <div class="item-title">${index + 1}. ${item.item}</div>
        <div class="status ${statusClass}">${statusText}</div>
        ${scorePoints > 0 ? `<span class="score-badge">${scorePoints}点</span>` : ''}
`;
                        
                        if (result.photo) {
                            htmlContent += `
        <div>
            <img src="${result.photo}" alt="点検写真${index + 1}" class="photo">
        </div>
`;
                        }
                        
                        if (result.comment) {
                            htmlContent += `
        <div class="comment">
            <strong>コメント:</strong> ${result.comment}
        </div>
`;
                        }
                        
                        htmlContent += `
    </div>
`;
                    });
                    
                    htmlContent += `
    <div class="footer">
        <p>この報告書は看護ステーション安全点検アプリで作成されました</p>
    </div>
</body>
</html>
`;
                    
                    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `安全点検報告書_${inspectionDate}_${inspectionLocation}.html`; // ファイル名にも場所を追加
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    
                    a.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    alert(`報告書をダウンロードしました。\n\n点検箇所: ${inspectionLocation}\n総合得点: ${totalScore}/${maxScore}点 (${scorePercentage}%)\n\nHTMLファイルをブラウザで開き、**「印刷」メニューからPDFとして保存**してください。`);
                    
                } catch (error) {
                    console.error('エラー発生:', error);
                    alert('エラーが発生しました: ' + error.message);
                }
            };
            
            const handleLogout = () => {
                if (window.confirm('ログアウトしますか？入力中のデータは失われます。')) {
                    setIsAuthenticated(false);
                    
                    // LocalStorageもクリア
                    localStorage.removeItem(STORAGE_KEY); 
                    
                    // Stateを初期化
                    setCheckResults(getInitialData().checkResults);
                    setInspector('');
                    setInspectionDate(new Date().toISOString().split('T')[0]);
                    setInspectionLocation(''); // ★点検箇所も初期化
                }
            };
            
            const { totalScore, maxScore, scorePercentage, evaluatedCount } = calculateTotalScore();
            
            return (
                <div className="max-w-4xl mx-auto p-4 bg-gray-50 min-h-screen">
                    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold text-gray-800">看護ステーション安全点検</h1>
                            <button
                                onClick={handleLogout}
                                className="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"
                            >
                                ログアウト
                            </button>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            {/* ★ 点検箇所ドロップダウンを追加 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    点検箇所 <span className="text-red-500">*</span>
                                </label>
                                <select
                                    value={inspectionLocation}
                                    onChange={(e) => setInspectionLocation(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                >
                                    <option value="">選択してください</option>
                                    {inspectionLocations.map((location, index) => (
                                        <option key={index} value={location}>{location}</option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    点検日
                                </label>
                                <input
                                    type="date"
                                    value={inspectionDate}
                                    onChange={(e) => setInspectionDate(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                />
                            </div>

                            {/* 点検者を右側に配置 */}
                            <div className="col-span-1 md:col-span-2 lg:col-span-1">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    点検者 <span className="text-red-500">*</span>
                                </label>
                                <select
                                    value={inspector}
                                    onChange={(e) => setInspector(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                >
                                    <option value="">選択してください</option>
                                    {inspectors.map((name, index) => (
                                        <option key={index} value={name}>{name}</option>
                                    ))}
                                </select>
                            </div>
                            
                        </div>
                        
                        {evaluatedCount > 0 && (
                            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-4 rounded-lg">
                                <div className="text-center">
                                    <div className="text-sm mb-1">現在の得点</div>
                                    <div className="text-3xl font-bold">{totalScore} / {maxScore}点</div>
                                    <div className="text-sm mt-1">達成率: {scorePercentage}% ({evaluatedCount}/{checkItems.length}項目評価済み)</div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {checkItems.map((item) => {
                        const result = checkResults[item.id];
                        const scorePoints = getStatusScore(result.status);
                        // ★ 評価済みかどうかの判定
                        const isEvaluated = result.status !== null; 

                        return (
                            <div 
                                key={item.id} 
                                // ★ 評価済みの場合は緑の枠線を追加
                                className={`bg-white rounded-lg shadow-md p-6 mb-4 border-l-4 ${isEvaluated ? 'border-green-500' : 'border-gray-300'}`}
                            >
                                <h3 className="font-medium text-gray-800 mb-4">
                                    {item.id}. {item.item}
                                    {scorePoints > 0 && (
                                        <span className="ml-3 text-sm bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full font-bold">
                                            {scorePoints}点
                                        </span>
                                    )}
                                </h3>
                                
                                <div className="flex gap-2 mb-4">
                                    <button
                                        onClick={() => handleStatusChange(item.id, 'good')}
                                        className={`flex items-center gap-2 px-4 py-2 rounded-md transition-colors ${
                                            result.status === 'good'
                                                ? 'bg-green-500 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        <Check size={18} />
                                        良好 (3点)
                                    </button>
                                    <button
                                        onClick={() => handleStatusChange(item.id, 'warning')}
                                        className={`flex items-center gap-2 px-4 py-2 rounded-md transition-colors ${
                                            result.status === 'warning'
                                                ? 'bg-yellow-500 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        <AlertTriangle size={18} />
                                        要改善 (2点)
                                    </button>
                                    <button
                                        onClick={() => handleStatusChange(item.id, 'danger')}
                                        className={`flex items-center gap-2 px-4 py-2 rounded-md transition-colors ${
                                            result.status === 'danger'
                                                ? 'bg-red-500 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        <X size={18} />
                                        危険 (1点)
                                    </button>
                                </div>
                                
                                <div className="mb-4">
                                    <label className="inline-flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-md cursor-pointer hover:bg-blue-600 transition-colors">
                                        <Camera size={18} />
                                        写真を撮影・添付
                                        <input
                                            type="file"
                                            accept="image/*"
                                            capture="environment"
                                            onChange={(e) => handlePhotoUpload(item.id, e)}
                                            className="hidden"
                                        />
                                    </label>
                                    {result.photo && (
                                        <div className="mt-2">
                                            <img
                                                src={result.photo}
                                                alt="点検写真"
                                                className="max-w-xs rounded-md border border-gray-300"
                                            />
                                        </div>
                                    )}
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        コメント・備考
                                    </label>
                                    <textarea
                                        value={result.comment}
                                        onChange={(e) => handleCommentChange(item.id, e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        rows="2"
                                        placeholder="特記事項があれば入力してください"
                                    />
                                </div>
                            </div>
                        );
                    })}
                    
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <button
                            onClick={generatePDF}
                            className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors font-medium"
                        >
                            <Download size={20} />
                            報告書を出力 (HTML形式)
                        </button>
                        <p className="text-sm text-gray-600 mt-2 text-center">
                            ※HTMLファイルをダウンロード後、ブラウザの**印刷機能からPDF保存**を推奨
                        </p>
                    </div>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SafetyInspectionApp />);
    </script>
</body>
</html>
